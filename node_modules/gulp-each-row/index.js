var through = require('through2');
var gutil = require('gulp-util');
var PluginError = gutil.PluginError;

// Process each rows and edit its content
// TODO: support streams and more data check
module.exports = function (callback) {

	// creating a stream through which each file will pass
	var stream = through.obj(function (file, enc, cb) {

		if (file.isStream()) {
			this.emit('error', new PluginError('eachRow', 'Streams are not supported at the moment!'));
			return cb();
		}

		if (file.isBuffer()) {
			
			// Get file contents
			var contents = file.contents.toString();
			
			// Parse to JSON
			var data = JSON.parse(contents);
			
			// New tmp array, for removing keys
			var tmp = [];
			
			// Test if source is an array/object
			if (typeof data !== 'object') {
				this.emit('error', new PluginError('eachRow', 'The source is not an array!'));
				return cb();
			}
			
			// Apply callback to the rows and append to tmp
			for (var i in data) {
				tmp.push(callback(data[i]));
			}
			
			// Return edited file data to buffer
			file.contents = new Buffer(JSON.stringify(tmp));
		}

		this.push(file);
		cb();
	});

	return stream;
};
